{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "provider",
  "type": "registry:component",
  "dependencies": ["@wallet-standard/react", "@nanostores/react"],
  "registryDependencies": [
    "@wallet-kit/context",
    "@wallet-kit/network",
    "@wallet-kit/storage",
    "@wallet-kit/use-wallet"
  ],
  "files": [
    {
      "path": "src/registry/default/ui/wallet/provider.tsx",
      "content": "\"use client\";\n\nimport { useStore } from \"@nanostores/react\";\nimport {\n  getUiWalletAccountStorageKey,\n  type UiWallet,\n  type UiWalletAccount,\n  uiWalletAccountBelongsToUiWallet,\n  uiWalletAccountsAreSame,\n  useWallets,\n} from \"@wallet-standard/react\";\nimport {\n  type ReactNode,\n  useCallback,\n  useEffect,\n  useMemo,\n  useState,\n} from \"react\";\n\nimport {\n  useAvailableWallets,\n  useWalletAccount,\n  useWalletNetwork,\n} from \"@/registry/default/hooks/use-wallet\";\nimport {\n  WalletAccountContext,\n  WalletNetworkContext,\n  type WalletNetworkContextValue,\n  WalletUiContext,\n  type WalletUiContextProviderProps,\n  type WalletUiContextValue,\n} from \"@/registry/default/lib/chains/context\";\nimport type { Network } from \"@/registry/default/lib/chains/network\";\nimport {\n  createStorageAccount,\n  createStorageNetwork,\n  type StorageAccount,\n  type StorageNetwork,\n} from \"@/registry/default/lib/chains/storage\";\n\ntype WalletNetworkContextProviderProps = {\n  children: ReactNode;\n  networks: Network[];\n  defaultNetworkId?: Network[\"id\"];\n  storage: StorageNetwork;\n  onNetworkChange?: (networkId: Network[\"id\"]) => void;\n};\n\nfunction WalletNetworkContextProvider({\n  children,\n  networks,\n  defaultNetworkId,\n  storage,\n  onNetworkChange,\n}: WalletNetworkContextProviderProps) {\n  const storedNetworkId = useStore(storage.value);\n\n  const networkFound = networks.find((n) => n.id === storedNetworkId);\n  const firstNetwork = networks[0];\n  const activeNetwork =\n    networkFound ??\n    networks.find((n) => n.id === defaultNetworkId) ??\n    firstNetwork;\n\n  if (!activeNetwork && networks.length > 0) {\n    console.warn(\"No active network found and networks list is not empty.\");\n  }\n\n  const value: WalletNetworkContextValue = {\n    network: activeNetwork ?? { id: \":\", label: \"\", url: \"\" },\n    networks,\n    setNetwork(networkId) {\n      const network = networks.find((n) => n.id === networkId);\n      if (!network) {\n        throw new Error(`Network ${networkId} not found`);\n      }\n      storage.set(networkId);\n      onNetworkChange?.(networkId);\n    },\n  };\n\n  return (\n    <WalletNetworkContext.Provider value={value}>\n      {children}\n    </WalletNetworkContext.Provider>\n  );\n}\n\nlet wasSetterInvoked = false;\n\nfunction getSavedWalletAccount(\n  wallets: readonly UiWallet[],\n  savedWalletNameAndAddress?: string\n): UiWalletAccount | undefined {\n  if (wasSetterInvoked) {\n    // After the user makes an explicit choice of wallet, stop trying to auto-select the\n    // saved wallet, if and when it appears.\n    return;\n  }\n  if (\n    !savedWalletNameAndAddress ||\n    typeof savedWalletNameAndAddress !== \"string\"\n  ) {\n    return;\n  }\n  const [savedWalletName, savedAccountAddress] =\n    savedWalletNameAndAddress.split(\":\");\n  if (!(savedWalletName && savedAccountAddress)) {\n    return;\n  }\n  const wallet = wallets.find((w) => w.name === savedWalletName);\n  if (!wallet) {\n    return;\n  }\n  return wallet.accounts.find((a) => a.address === savedAccountAddress);\n}\n\nfunction findWalletAccount(\n  account: UiWalletAccount,\n  wallets: readonly UiWallet[]\n): UiWalletAccount | undefined {\n  for (const uiWallet of wallets) {\n    for (const uiWalletAccount of uiWallet.accounts) {\n      if (uiWalletAccountsAreSame(account, uiWalletAccount)) {\n        return uiWalletAccount;\n      }\n    }\n    if (\n      uiWalletAccountBelongsToUiWallet(account, uiWallet) &&\n      uiWallet.accounts[0]\n    ) {\n      return uiWallet.accounts[0];\n    }\n  }\n  return;\n}\n\nfunction WalletAccountContextProvider({\n  children,\n  storage = createStorageAccount(),\n}: {\n  children: React.ReactNode;\n  storage?: StorageAccount;\n}) {\n  const { network } = useWalletNetwork();\n  const wallets = useWallets();\n  const accountId = useStore(storage.value);\n  const [account, setAccountInternal] = useState<UiWalletAccount | undefined>(\n    () => getSavedWalletAccount(wallets, accountId)\n  );\n\n  const setAccount = useCallback(\n    (setStateAction: React.SetStateAction<UiWalletAccount | undefined>) => {\n      setAccountInternal((prevAccount) => {\n        wasSetterInvoked = true;\n        return typeof setStateAction === \"function\"\n          ? setStateAction(prevAccount)\n          : setStateAction;\n      });\n    },\n    []\n  );\n\n  useEffect(() => {\n    if (wasSetterInvoked) {\n      const accountKey = account\n        ? getUiWalletAccountStorageKey(account)\n        : undefined;\n      storage.set(accountKey ? accountKey : undefined);\n    }\n  }, [account, storage]);\n\n  useEffect(() => {\n    const savedWalletAccount = getSavedWalletAccount(wallets, accountId);\n    if (savedWalletAccount && !account) {\n      setAccountInternal(savedWalletAccount);\n    }\n  }, [accountId, wallets, account]);\n\n  const walletAccount = useMemo(() => {\n    if (!account) {\n      return;\n    }\n    return findWalletAccount(account, wallets);\n  }, [account, wallets]);\n\n  useEffect(() => {\n    if (account && !walletAccount && !wasSetterInvoked) {\n      setTimeout(() => {\n        setAccountInternal(undefined);\n      }, 0);\n    }\n  }, [account, walletAccount]);\n\n  const wallet = useMemo(() => {\n    if (!walletAccount) {\n      return;\n    }\n    for (const uiWallet of wallets) {\n      for (const uiWalletAccount of uiWallet.accounts) {\n        if (uiWalletAccountsAreSame(walletAccount, uiWalletAccount)) {\n          return uiWallet;\n        }\n      }\n      if (\n        uiWalletAccountBelongsToUiWallet(walletAccount, uiWallet) &&\n        uiWallet.accounts[0]\n      ) {\n        // If the selected account belongs to this connected wallet, at least, then\n        // select one of its accounts.\n        return uiWallet;\n      }\n    }\n  }, [walletAccount, wallets]);\n\n  const accountKeys = useMemo(() => {\n    if (!account) {\n      return [];\n    }\n    return [network.id, getUiWalletAccountStorageKey(account)].filter(Boolean);\n  }, [account, network.id]);\n  return (\n    <WalletAccountContext.Provider\n      value={useMemo(\n        () => ({\n          account: walletAccount,\n          accountKeys,\n          network,\n          setAccount,\n          wallet,\n        }),\n        [walletAccount, wallet, accountKeys, setAccount, network]\n      )}\n    >\n      {children}\n    </WalletAccountContext.Provider>\n  );\n}\n\nfunction getChainNamespace(networkId: string | undefined): string | undefined {\n  return networkId?.split(\":\")[0];\n}\n\nfunction getChainPrefix(namespace: string | undefined): string | undefined {\n  return namespace ? `${namespace}:` : undefined;\n}\n\nfunction isClipboardAvailable(): boolean {\n  return (\n    typeof globalThis !== \"undefined\" &&\n    globalThis.navigator?.clipboard?.writeText !== undefined\n  );\n}\n\nasync function copyToClipboard(text: string): Promise<void> {\n  if (!isClipboardAvailable()) {\n    return;\n  }\n  await globalThis.navigator.clipboard.writeText(text);\n}\n\nfunction WalletUiContextProvider({\n  children,\n  client,\n}: WalletUiContextProviderProps) {\n  const { account, accountKeys, setAccount, wallet } = useWalletAccount();\n  const { network } = useWalletNetwork();\n\n  const chainNamespace = getChainNamespace(network?.id);\n  const chainPrefix = getChainPrefix(chainNamespace);\n\n  const wallets = useAvailableWallets(chainPrefix);\n  const connected = Boolean(wallet?.accounts && wallet.accounts.length > 0);\n  const [isModalOpen, setIsModalOpen] = useState(false);\n\n  const connect = useCallback(\n    (walletAccount: UiWalletAccount) => {\n      setAccount(walletAccount);\n      setIsModalOpen(false);\n    },\n    [setAccount]\n  );\n\n  const disconnect = useCallback(() => {\n    setAccount(undefined);\n  }, [setAccount]);\n\n  const copy = useCallback(async () => {\n    const address = account?.address;\n    if (!address) {\n      return;\n    }\n    await copyToClipboard(address);\n  }, [account]);\n\n  const value = useMemo<WalletUiContextValue>(\n    () => ({\n      account,\n      accountKeys,\n      client,\n      connect,\n      connected,\n      copy,\n      disconnect,\n      isModalOpen,\n      network,\n      setIsModalOpen,\n      wallet,\n      wallets,\n    }),\n    [\n      account,\n      accountKeys,\n      client,\n      connect,\n      connected,\n      copy,\n      disconnect,\n      isModalOpen,\n      network,\n      wallet,\n      wallets,\n    ]\n  );\n\n  return (\n    <WalletUiContext.Provider value={value}>\n      {children}\n    </WalletUiContext.Provider>\n  );\n}\n\ninterface WalletConfig extends Omit<WalletUiContextProviderProps, \"children\"> {\n  accountStorage?: StorageAccount;\n  networkStorage?: StorageNetwork;\n  networks: Network[];\n  defaultNetworkId?: Network[\"id\"];\n  onNetworkChange?: (networkId: Network[\"id\"]) => void;\n}\n\nfunction createWalletConfig(props: WalletConfig): WalletConfig {\n  return { ...props };\n}\n\nfunction WalletProvider({\n  children,\n  config: {\n    accountStorage,\n    networkStorage,\n    networks,\n    defaultNetworkId,\n    onNetworkChange,\n    ...uiConfig\n  },\n}: {\n  children: ReactNode;\n  config: WalletConfig;\n}) {\n  return (\n    <WalletNetworkContextProvider\n      defaultNetworkId={defaultNetworkId}\n      networks={networks}\n      onNetworkChange={onNetworkChange}\n      storage={networkStorage ?? createStorageNetwork()}\n    >\n      <WalletAccountContextProvider\n        storage={accountStorage ?? createStorageAccount()}\n      >\n        <WalletUiContextProvider {...uiConfig}>\n          {children}\n        </WalletUiContextProvider>\n      </WalletAccountContextProvider>\n    </WalletNetworkContextProvider>\n  );\n}\n\nexport { WalletProvider, createWalletConfig };\n",
      "type": "registry:component",
      "target": "components/wallet/provider.tsx"
    }
  ],
  "categories": ["wallet"]
}
